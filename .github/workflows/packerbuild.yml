name: Packer Build Custom Image
 
on:
  pull_request:
   types: [closed]
 
jobs:
  packer_init_validate_build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    env:
      DATABASE: webappDB
      DATABASE_URL: ${{secrets.DATABASE_URL}}
      DATABASE_USERNAME: ${{secrets.DATABASE_USERNAME}}
      DATABASE_PASSWORD: ${{secrets.DATABASE_PASSWORD}}
    
    steps:
      - name: Checkout code from branch
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
 
      - name: Zip all the webApp files
        run: |
          zip -r webapp.zip ./
          pwd
      - name: check the current
        run: ls -la

      - name: Setup google config
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_CREDENTIALS}}

      - name: Setup MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql database: 'webappDB'
          mysql user: 'web-app'
          mysql password: '${{ secrets.DATABASE_PASSWORD }}'

      - name: Build with Maven
        run: |
          mvn -B package --file pom.xml

      - name: Setup `packer`
        uses: hashicorp/setup-packer@main
        id: setup
        with:
          version: "latest"
 
      - name: Run `packer init`
        id: init
        run: packer init .

      - name: Packer build
        id: build
        run: packer build main.pkr.hcl

      - name: Create new instance template version
        run: |
          gcloud compute images list  --sort-by=~creationTimestamp --format='value(NAME)' --limit=1
          gcloud compute instance-templates create webapp-instance-template-version2 --project=devv-415008 --machine-type=e2-medium --network-interface=network-tier=PREMIUM,subnet=webapp --metadata=startup-script=touch\ /tmp/application.properties$'\n'echo\ \"spring.datasource.driver-class-name=com.mysql.jdbc.Driver\"\ \>\>\ /tmp/application.properties$'\n'echo\ \"spring.datasource.url=jdbc:mysql://10.60.0.2/webapp\?createDatabaseIfNotExist=true\&useUnicode=true\&characterEncoding=utf8\"\ \>\>\ /tmp/application.properties$'\n'echo\ \"spring.datasource.username=webapp\"\ \>\>\ /tmp/application.properties$'\n'echo\ \"spring.datasource.password=v\#J5K9FpviC\*\<\<K_\"\ \>\>\ /tmp/application.properties$'\n'echo\ \"spring.jpa.properties.hibernate.show_sql=true\"\ \>\>\ /tmp/application.properties$'\n'echo\ \"spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect\"\ \>\>\ /tmp/application.properties$'\n'echo\ \"spring.jpa.hibernate.ddl-auto=update\"\ \>\>\ /tmp/application.properties$'\n'echo\ \"projectId=devv-415008\"\ \>\>\ /tmp/application.properties$'\n'echo\ \"topicId=verify_email\"\ \>\>\ /tmp/application.properties$'\n' --maintenance-policy=MIGRATE --provisioning-model=STANDARD --service-account=devv-906@devv-415008.iam.gserviceaccount.com --scopes=https://www.googleapis.com/auth/cloud-platform --region=us-east1 --tags=webapp,web,sql,db,allow-health-check --create-disk=auto-delete=yes,boot=yes,device-name=persistent-disk-0,image=projects/devv-415008/global/images/packer-custom-centos8-image,kms-key=projects/devv-415008/locations/us-east1/keyRings/ckms-key-ring/cryptoKeys/vm-crypto-key,mode=rw,size=100,type=pd-balanced --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --labels=app=web,environment=dev --reservation-affinity=any

      - name: Configure instance group with new template
        run: |
          gcloud compute instance-groups managed set-instance-template webapp-igm --region=us-east1 --template=webapp-instance-template-version2 --project=devv-415008

      - name: Start rolling update
        run: |
          gcloud compute instance-groups managed rolling-action start-update webapp-igm --version=template="webapp-instance-template-version2" --max-surge=5 --region=us-east1 --project=devv-415008

      - name: Monitor instance group update
        run: |
          status="RUNNING"
          while [ "$status" != "ROLLOUT_DONE" ]; do
          status=$(gcloud compute instance-groups managed describe webapp-igm --region=us-east1 --project=devv-415008 --format='value(instanceGroupStatus.versionTarget.utilizationTarget)')
          sleep 10
          done


  
     
     